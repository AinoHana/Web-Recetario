{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Receta - El Recetario{% endblock %}

{% block content %}
<div class="main-content-new">
    <div class="form-container">
        <h1 class="form-title">Editar Receta: {{ receta.titulo }}</h1>
        
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="recipe-form" id="recipe-form">
            {% csrf_token %}

            <div class="form-section">
                <h2>Información General</h2>
                <div class="form-field">
                    {{ form.titulo.label_tag }}
                    {{ form.titulo }}
                    {% if form.titulo.errors %}<div class="error-message">{{ form.titulo.errors }}</div>{% endif %}
                </div>
                <div class="form-field">
                    {{ form.descripcion.label_tag }}
                    {{ form.descripcion }}
                    {% if form.descripcion.errors %}<div class="error-message">{{ form.descripcion.errors }}</div>{% endif %}
                </div>
                <div class="form-field">
                    {{ form.categoria.label_tag }}
                    {{ form.categoria }}
                    {% if form.categoria.errors %}<div class="error-message">{{ form.categoria.errors }}</div>{% endif %}
                </div>
                <div class="form-field">
                    {{ form.tiempo_preparacion.label_tag }}
                    {{ form.tiempo_preparacion }}
                    {% if form.tiempo_preparacion.errors %}<div class="error-message">{{ form.tiempo_preparacion.errors }}</div>{% endif %}
                </div>
                <div class="form-field">
                    {{ form.porciones.label_tag }}
                    {{ form.porciones }}
                    {% if form.porciones.errors %}<div class="error-message">{{ form.porciones.errors }}</div>{% endif %}
                </div>
                
                {# Campo para subir la nueva imagen #}
                <div class="form-field">
                    {{ form.imagen.label_tag }}
                    {{ form.imagen }}
                    {% if form.imagen.errors %}<div class="error-message">{{ form.imagen.errors }}</div>{% endif %}
                </div>

                {# Contenedor para la imagen actual y el botón de eliminar #}
                <div id="current-image-preview-container" class="current-image-preview {% if not receta.imagen %}hidden{% endif %}">
                    <p id="current-image-label">Imagen actual:</p>
                    <div class="relative image-display-container">
                        <img id="current-image" src="{% if receta.imagen %}{{ receta.imagen.url }}{% endif %}" alt="Imagen actual" class="image-preview-thumbnail">
                        <button type="button" id="delete-image-btn" class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 shadow-lg hover:bg-red-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    {# Este checkbox oculto es esencial para la lógica de borrado de Django. Se marca con JS. #}
                    {% if form.imagen.field.required == False %}
                        {{ form.imagen.clear }}
                        <label for="{{ form.imagen.clear.id_for_label }}" class="sr-only">Borrar imagen actual</label>
                    {% endif %}
                </div>
            </div>

            <div class="form-section">
                <h2>Ingredientes</h2>
                <div id="ingredientes-formset-container">
                    {{ formset_ingredientes.management_form }}
                    {% for form_ingrediente in formset_ingredientes %}
                        <div class="ingrediente-formset-row">
                            {% for hidden_field in form_ingrediente.hidden_fields %}
                                {{ hidden_field }}
                            {% endfor %}
                            <div class="form-field small-field">
                                {{ form_ingrediente.nombre.label_tag }}
                                {{ form_ingrediente.nombre }}
                                {% if form_ingrediente.nombre.errors %}<div class="error-message">{{ form_ingrediente.nombre.errors }}</div>{% endif %}
                            </div>
                            <div class="form-field small-field">
                                {{ form_ingrediente.cantidad.label_tag }}
                                {{ form_ingrediente.cantidad }}
                                {% if form_ingrediente.cantidad.errors %}<div class="error-message">{{ form_ingrediente.cantidad.errors }}</div>{% endif %}
                            </div>
                            <div class="form-field small-field">
                                {{ form_ingrediente.unidad.label_tag }}
                                {{ form_ingrediente.unidad }}
                                {% if form_ingrediente.unidad.errors %}<div class="error-message">{{ form_ingrediente.unidad.errors }}</div>{% endif %}
                            </div>
                            {% if form_ingrediente.instance.pk %}
                                <div class="form-field delete-checkbox">
                                    {{ form_ingrediente.DELETE }}
                                    {{ form_ingrediente.DELETE.label_tag }}
                                </div>
                            {% endif %}
                            <button type="button" class="remove-item-button" data-form-type="ingrediente">Eliminar</button>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-ingrediente" class="button-secondary add-item-button">Añadir Ingrediente</button>
            </div>

            <div class="form-section">
                <h2>Pasos</h2>
                <div id="pasos-formset-container">
                    {{ formset_pasos.management_form }}
                    {% for form_paso in formset_pasos %}
                        <div class="paso-formset-row">
                            {% for hidden_field in form_paso.hidden_fields %}
                                {{ hidden_field }}
                            {% endfor %}
                            <div class="form-field small-field">
                                {{ form_paso.titulo.label_tag }}
                                {{ form_paso.titulo }}
                                {% if form_paso.titulo.errors %}<div class="error-message">{{ form_paso.titulo.errors }}</div>{% endif %}
                            </div>
                            <div class="form-field large-field">
                                {{ form_paso.descripcion.label_tag }}
                                {{ form_paso.descripcion }}
                                {% if form_paso.descripcion.errors %}<div class="error-message">{{ form_paso.descripcion.errors }}</div>{% endif %}
                            </div>
                            {% if form_paso.instance.pk %}
                                <div class="form-field delete-checkbox">
                                    {{ form_paso.DELETE }}
                                    {{ form_paso.DELETE.label_tag }}
                                </div>
                            {% endif %}
                            <button type="button" class="remove-item-button" data-form-type="paso">Eliminar</button>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-paso" class="button-secondary add-item-button">Añadir Paso</button>
            </div>

            <div class="form-actions">
                <button type="submit" class="button-primary submit-button">Actualizar Receta</button>
                <button type="submit" formaction="{% url 'recetas_app:previsualizar_receta' %}" formtarget="_blank" class="button-secondary preview-button">Previsualizar Receta</button>
                <button type="button" class="button-secondary" onclick="history.back()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

{# Plantillas ocultas para los formularios vacíos de formsets #}
<template id="empty-ingrediente-form">
    <div class="ingrediente-formset-row">
        {{ formset_ingredientes.empty_form.as_p }}
        <button type="button" class="remove-item-button" data-form-type="ingrediente">Eliminar</button>
    </div>
</template>

<template id="empty-paso-form">
    <div class="paso-formset-row">
        {{ formset_pasos.empty_form.as_p }}
        <button type="button" class="remove-item-button" data-form-type="paso">Eliminar</button>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Lógica para añadir/eliminar formsets (Ingredientes y Pasos) ---
        function addForm(formType) {
            const container = document.getElementById(`${formType}s-formset-container`);
            const totalFormsInput = document.querySelector(`#id_${formType}s-TOTAL_FORMS`);
            let currentTotalForms = parseInt(totalFormsInput.value);
            const template = document.getElementById(`empty-${formType}-form`);
            const newFormRow = template.content.cloneNode(true);
            newFormRow.querySelectorAll('[name*="__prefix__"]').forEach(element => {
                element.name = element.name.replace(/__prefix__/g, currentTotalForms);
                element.id = element.id.replace(/__prefix__/g, currentTotalForms);
                if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'number')) {
                    element.classList.add('form-input');
                } else if (element.tagName === 'TEXTAREA') {
                    element.classList.add('form-textarea');
                }
            });
            newFormRow.querySelectorAll('label[for*="__prefix__"]').forEach(element => {
                element.htmlFor = element.htmlFor.replace(/__prefix__/g, currentTotalForms);
            });
            container.appendChild(newFormRow);
            totalFormsInput.value = currentTotalForms + 1;
            const addedButton = container.lastElementChild.querySelector('.remove-item-button');
            if (addedButton) {
                addedButton.addEventListener('click', removeForm);
            }
        }
        function removeForm(event) {
            const button = event.target;
            const formType = button.dataset.formType;
            const row = button.closest(`.${formType}-formset-row`);
            const totalFormsInput = document.querySelector(`#id_${formType}s-TOTAL_FORMS`);
            const visibleForms = Array.from(document.querySelectorAll(`.${formType}-formset-row`)).filter(item => {
                const cb = item.querySelector('input[name$="-DELETE"]');
                return !(cb && cb.checked);
            }).length;
            if (visibleForms <= 1 && (formType === 'ingrediente' || formType === 'paso')) {
                showMessageModal('¡Atención!', `La receta debe tener al menos un ${formType}.`, 'warning');
                return;
            }
            const idInput = row.querySelector('input[name$="-id"]');
            const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
            if (idInput && idInput.value) {
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                }
                row.style.display = 'none';
                showMessageModal('Elemento Marcado para Eliminar', 'Este elemento será eliminado al guardar la receta.', 'success');
            } else {
                row.remove();
                totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
                showMessageModal('Elemento Eliminado', 'El elemento nuevo ha sido removido.', 'success');
            }
        }
        document.getElementById('add-ingrediente').addEventListener('click', () => addForm('ingrediente'));
        document.getElementById('add-paso').addEventListener('click', () => addForm('paso'));
        document.querySelectorAll('.remove-item-button').forEach(button => {
            button.addEventListener('click', removeForm);
        });

        // --- Lógica para la imagen (nueva funcionalidad) ---
        const imagenInput = document.getElementById('id_imagen');
        const imagePreviewContainer = document.getElementById('current-image-preview-container');
        const currentImage = document.getElementById('current-image');
        const deleteImageBtn = document.getElementById('delete-image-btn');
        const clearCheckbox = document.getElementById('id_imagen-clear');

        // Escuchar cambios en el input de archivo
        if (imagenInput) {
            imagenInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentImage.src = e.target.result;
                        imagePreviewContainer.classList.remove('hidden');
                        // Asegurarse de que el checkbox de borrar esté desmarcado
                        if (clearCheckbox) {
                            clearCheckbox.checked = false;
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    // Si se borra la selección, ocultamos la previsualización
                    // Usamos una URL de placeholder para que la imagen no se muestre rota
                    currentImage.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 24 24"%3E%3Cpath fill="%23ccc" d="M19 5v14H5V5h14zm0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/%3E%3C/svg%3E';
                    imagePreviewContainer.classList.add('hidden');
                }
            });
        }

        // Escuchar el clic en el botón de eliminar imagen
        if (deleteImageBtn) {
            deleteImageBtn.addEventListener('click', function() {
                // Ocultar el contenedor de la imagen
                imagePreviewContainer.classList.add('hidden');
                
                // Limpiar el campo de archivo para que no se envíe nada
                if (imagenInput) {
                    imagenInput.value = '';
                }
                
                // Marcar el checkbox de borrado si existe (Django lo necesita)
                if (clearCheckbox) {
                    clearCheckbox.checked = true;
                }
            });
        }

        // --- Lógica para el botón de previsualización ---
        const previewButton = document.querySelector('.preview-button');
        if (previewButton) {
            const form = document.getElementById('recipe-form');
            const originalFormAction = form.action; 
            previewButton.addEventListener('click', function(event) {
                form.action = "{% url 'recetas_app:previsualizar_receta' %}"; 
                form.target = "_blank"; 
                setTimeout(() => {
                    form.action = originalFormAction; 
                    form.target = "_self"; 
                }, 100); 
            });
        }

        // --- Lógica para el modal de mensajes ---
        function showMessageModal(title, message, type = 'info') {
            const modal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            if (modalTitle && modalMessage && modal) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalTitle.classList.remove('text-red-800', 'text-green-800', 'text-gray-800', 'text-orange-800');
                if (type === 'error') {
                    modalTitle.classList.add('text-red-800');
                } else if (type === 'success') {
                    modalTitle.classList.add('text-green-800');
                } else if (type === 'warning') {
                    modalTitle.classList.add('text-orange-800');
                } else {
                    modalTitle.classList.add('text-gray-800');
                }
                modal.style.display = 'flex';
            }
        }
        function closeModal() {
            const modal = document.getElementById('messageModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        const closeButton = document.querySelector('#messageModal button');
        if (closeButton) {
            closeButton.addEventListener('click', closeModal);
        }

        // --- Validación final antes de enviar el formulario principal ---
        document.getElementById('recipe-form').addEventListener('submit', function(event) {
            const ingredientesContainer = document.getElementById('ingredientes-formset-container');
            const pasosContainer = document.getElementById('pasos-formset-container');
            const visibleIngredients = Array.from(ingredientesContainer.querySelectorAll('.ingrediente-formset-row')).filter(item => {
                const deleteCheckbox = item.querySelector('input[name$="-DELETE"]');
                return !(deleteCheckbox && deleteCheckbox.checked);
            });
            const visiblePasos = Array.from(pasosContainer.querySelectorAll('.paso-formset-row')).filter(item => {
                const deleteCheckbox = item.querySelector('input[name$="-DELETE"]');
                return !(deleteCheckbox && deleteCheckbox.checked);
            });
            if (visibleIngredients.length === 0) {
                event.preventDefault();
                showMessageModal('Error de Validación', 'La receta debe tener al menos un ingrediente.', 'error');
                return;
            }
            if (visiblePasos.length === 0) {
                event.preventDefault();
                showMessageModal('Error de Validación', 'La receta debe tener al menos un paso.', 'error');
            }
        });
    });
</script>
{% endblock %}