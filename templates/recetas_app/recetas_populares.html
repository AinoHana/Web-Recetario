{% extends 'base.html' %}
{% load static %}

{% block title %}Recetas Más Populares - El Recetario{% endblock %}

{% block content %}
<div class="recipe-popular-main-content">
    <h2 class="recipe-popular-section-title">Nuestras Recetas Más Populares</h2>
    <p class="recipe-popular-section-description">Descubre las recetas favoritas de nuestra comunidad, ¡las que más veces han sido guardadas!</p>

    {# Controles de Ordenamiento para populares #}
    <div class="recipe-popular-sort-options-container">
        <span class="recipe-popular-sort-label">Ordenar por:</span>
        <a href="?order_by=populares&direction=desc"
           class="recipe-popular-sort-button {% if current_order_by == 'populares' and current_direction == 'desc' %}active{% endif %}"
           data-order-by="populares" data-direction="desc">
            Popularidad (Mayor a Menor)
        </a>
        <a href="?order_by=populares&direction=asc"
           class="recipe-popular-sort-button {% if current_order_by == 'populares' and current_direction == 'asc' %}active{% endif %}"
           data-order-by="populares" data-direction="asc">
            Popularidad (Menor a Mayor)
        </a>
    </div>
    {# FIN Controles de Ordenamiento #}

    <div id="recipes-grid-container" class="recipe-popular-grid-container">
        {% include 'recetas_app/partials/popular_recipes_grid.html' %}
    </div>

    {# Controles de Paginación #}
    <div class="recipe-popular-pagination">
        <span class="recipe-popular-step-links">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&order_by={{ current_order_by }}&direction={{ current_direction }}" class="recipe-popular-pagination-btn">Anterior</a>
            {% endif %}

            <span class="recipe-popular-pagination-current">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&order_by={{ current_order_by }}&direction={{ current_direction }}" class="recipe-popular-pagination-btn">Siguiente</a>
            {% endif %}
        </span>
    </div>
</div>
{% endblock content %}

{% block extra_body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Hacemos clicables las tarjetas de receta al cargar la página.
        function attachCardClickListeners() {
            document.querySelectorAll('.recipe-popular-card').forEach(card => {
                card.removeEventListener('click', handleCardClick);
                card.addEventListener('click', handleCardClick);
            });
        }

        function handleCardClick(event) {
            if (event.target.closest('form') || event.target.tagName === 'A' || event.target.closest('button')) {
                return; 
            }
            const url = this.dataset.url;
            if (url) {
                window.location.href = url;
            }
        }

        // Lógica para los botones de ordenamiento con AJAX
        document.querySelectorAll('.recipe-popular-sort-button').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); 

                const currentUrl = new URL(window.location.href);
                const orderBy = this.dataset.orderBy;
                const direction = this.dataset.direction;

                currentUrl.searchParams.set('order_by', orderBy);
                currentUrl.searchParams.set('direction', direction);
                currentUrl.searchParams.set('page', 1);

                document.querySelectorAll('.recipe-popular-sort-button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                fetch(currentUrl.toString(), {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const recipesGridContainer = document.getElementById('recipes-grid-container');
                    if (recipesGridContainer) {
                        recipesGridContainer.innerHTML = data.html_recetas;
                        document.querySelector('.recipe-popular-pagination').innerHTML = data.html_pagination;
                        attachCardClickListeners();
                    }
                })
                .catch(error => {
                    console.error('Error al ordenar recetas populares:', error);
                    console.error('Hubo un error al ordenar las recetas. Por favor, inténtalo de nuevo.');
                });
            });
        });

        // Lógica para la paginación con AJAX
        document.querySelector('.recipe-popular-pagination').addEventListener('click', function(event) {
            if (event.target.tagName === 'A' && event.target.classList.contains('recipe-popular-pagination-btn')) {
                event.preventDefault();
                const pageUrl = event.target.href;

                fetch(pageUrl, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const recipesGridContainer = document.getElementById('recipes-grid-container');
                    if (recipesGridContainer) {
                        recipesGridContainer.innerHTML = data.html_recetas;
                        document.querySelector('.recipe-popular-pagination').innerHTML = data.html_pagination;
                        attachCardClickListeners();
                    }
                })
                .catch(error => console.error('Error al paginar recetas populares:', error));
            }
        });

        attachCardClickListeners(); 
    });
</script>
{% endblock extra_body_scripts %}