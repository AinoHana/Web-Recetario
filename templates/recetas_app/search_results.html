{% extends 'base.html' %}
{% load static %}

{% block title %}Resultados de Búsqueda - El Recetario{% endblock title %}

{% block content %}
<div class="main-content-new">
    <h2 class="section-title">Resultados de Búsqueda {% if search_type == 'simple' %}(Simple){% else %}(Avanzada){% endif %}</h2>
    <div class="search-results-container">
        {% if query %}
            <p class="search-query-info">Mostrando resultados para: "<strong>{{ query }}</strong>"</p>
        {% elif exact_phrase or similar_words or ingredient or recipe_type %}
            <p class="search-query-info">Mostrando resultados para tu búsqueda avanzada.</p>
            {# Mostrar criterios de búsqueda avanzada si están presentes #}
            <ul class="advanced-search-criteria">
                {% if exact_phrase %}<li><span class="criteria-label">Frase exacta:</span> "{{ exact_phrase }}"</li>{% endif %}
                {% if similar_words %}<li><span class="criteria-label">Palabras similares:</span> "{{ similar_words }}"</li>{% endif %}
                {% if ingredient %}<li><span class="criteria-label">Ingrediente:</span> "{{ ingredient }}"</li>{% endif %}
                {% if selected_category %}<li><span class="criteria-label">Categoría:</span> {{ categories|get_item:selected_category }}</li>{% endif %}
                {# Asumiendo que 'categories' es un queryset y 'get_item' es un filtro personalizado o que puedes acceder al nombre directamente #}
            </ul>
        {% endif %}

        {# Controles de Ordenamiento (NUEVO) #}
        <div class="sort-options-container">
            <span class="sort-label">Ordenar por:</span>
            {% comment %}
                Construimos la URL base para el ordenamiento, manteniendo los parámetros de búsqueda existentes.
                Para ello, verificamos si es una búsqueda simple o avanzada y construimos la query string.
            {% endcomment %}
            {% if search_type == 'simple' %}
                {% with base_query_params='q='|add:query %}
                    <a href="?{{ base_query_params }}&order_by=fecha_publicacion&direction=desc"
                       class="sort-button {% if current_order_by == 'fecha_publicacion' and current_direction == 'desc' %}active{% endif %}">
                        Más Recientes
                    </a>
                    <a href="?{{ base_query_params }}&order_by=fecha_publicacion&direction=asc"
                       class="sort-button {% if current_order_by == 'fecha_publicacion' and current_direction == 'asc' %}active{% endif %}">
                        Más Antiguas
                    </a>
                    <a href="?{{ base_query_params }}&order_by=titulo&direction=asc"
                       class="sort-button {% if current_order_by == 'titulo' and current_direction == 'asc' %}active{% endif %}">
                        Título (A-Z)
                    </a>
                    <a href="?{{ base_query_params }}&order_by=titulo&direction=desc"
                       class="sort-button {% if current_order_by == 'titulo' and current_direction == 'desc' %}active{% endif %}">
                        Título (Z-A)
                    </a>
                {% endwith %}
            {% else %} {# search_type == 'advanced' #}
                {% comment %}
                    Construimos la query string para búsqueda avanzada.
                    Usamos un filtro personalizado 'build_query_string' o lo construimos manualmente aquí.
                    Para simplificar, lo construiremos manualmente.
                {% endcomment %}
                {% with base_query_params='' %}
                    {% if exact_phrase %}{% with base_query_params=base_query_params|add:'exact_phrase='|add:exact_phrase|add:'&' %}{% endwith %}{% endif %}
                    {% if similar_words %}{% with base_query_params=base_query_params|add:'similar_words='|add:similar_words|add:'&' %}{% endwith %}{% endif %}
                    {% if ingredient %}{% with base_query_params=base_query_params|add:'ingredient='|add:ingredient|add:'&' %}{% endwith %}{% endif %}
                    {% if selected_category %}{% with base_query_params=base_query_params|add:'category='|add:selected_category|add:'&' %}{% endwith %}{% endif %}
                    {# Asegurarse de quitar el último '&' si no hay más parámetros, o manejarlo en la vista #}

                    <a href="?{{ base_query_params }}order_by=fecha_publicacion&direction=desc"
                       class="sort-button {% if current_order_by == 'fecha_publicacion' and current_direction == 'desc' %}active{% endif %}">
                        Más Recientes
                    </a>
                    <a href="?{{ base_query_params }}order_by=fecha_publicacion&direction=asc"
                       class="sort-button {% if current_order_by == 'fecha_publicacion' and current_direction == 'asc' %}active{% endif %}">
                        Más Antiguas
                    </a>
                    <a href="?{{ base_query_params }}order_by=titulo&direction=asc"
                       class="sort-button {% if current_order_by == 'titulo' and current_direction == 'asc' %}active{% endif %}">
                        Título (A-Z)
                    </a>
                    <a href="?{{ base_query_params }}order_by=titulo&direction=desc"
                       class="sort-button {% if current_order_by == 'titulo' and current_direction == 'desc' %}active{% endif %}">
                        Título (Z-A)
                    </a>
                {% endwith %}
            {% endif %}
        </div>

        {% if results %}
            <div class="grid-container">
                {% for receta in results %}
                    <div class="recipe-card">
                        {% if receta.imagen %}
                            <img src="{{ receta.imagen.url }}" alt="{{ receta.titulo }}" class="recipe-image">
                        {% else %}
                            <img src="https://placehold.co/400x300/E0E0E0/616161?text=Sin+Imagen" alt="Imagen no disponible" class="recipe-image">
                        {% endif %}
                        <h3 class="recipe-title">{{ receta.titulo }}</h3>
                        <p class="recipe-description">{{ receta.descripcion|truncatechars:100 }}</p>
                        <a href="{% url 'recetas_app:detalle_receta' pk=receta.pk %}" class="btn-primary">Ver Receta</a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-results-message">No se encontraron recetas que coincidan con tu búsqueda.</p>
        {% endif %}
    </div>
</div>
