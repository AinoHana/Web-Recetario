{# apps/recetas_app/templates/recetas_app/home.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Inicio - El Recetario{% endblock %}

{% block content %}

    <!-- Columna Izquierda: Categorías (Sidebar) -->
    <aside class="sidebar">
        <h2 class="sidebar-title">Categorías</h2>
        <ul class="category-list">
            {# Este bucle ahora usa el campo fa_icon para mostrar el ícono de cada categoría #}
            {% for categoria in categorias %}
            <li class="category-item">
                <a href="{% url 'recetas_app:home' %}?categoria={{ categoria.slug }}"
                   class="category-link {% if categoria_slug == categoria.slug %}active{% endif %}">
                    {# Aquí usamos la variable que se guarda en la base de datos #}
                    <i class="{{ categoria.fa_icon }} category-icon"></i> {{ categoria.nombre }}
                </a>
            </li>
            {% endfor %}

            {# Enlace para ver todas las categorías - CORREGIDO con la clase de Font Awesome 6 #}
            <li class="category-item">
                <a href="{% url 'recetas_app:home' %}" class="category-link {% if not categoria_slug %}active{% endif %}">
                    <i class="fa-solid fa-grip-horizontal category-icon"></i> Todas las Categorías
                </a>
            </li>
        </ul>
    </aside>

    <!-- Columna Derecha: Contenido Principal (Recetas) -->
    <div class="main-content-area"> 
        <div class="section-wrapper">
            <h2 class="section-title">
                {# Cambios aquí para hacer el título dinámico #}
                {% if categoria_nombre %}
                    Recetas de <span class="highlight-text">{{ categoria_nombre }}</span>
                {% else %}
                    Recetas
                {% endif %}
            </h2>

            {# Controles de Ordenamiento #}
            <div class="sort-options-container">
                <span class="sort-label">Filtrar por:</span>
                {# Ordenar por Fecha #}
                <a href="{% url 'recetas_app:home' %}{% if categoria_slug %}?categoria={{ categoria_slug }}&{% else %}?{% endif %}order_by=fecha_publicacion&direction=asc"
                   class="sort-button {% if current_order_by == 'fecha_publicacion' and current_direction == 'asc' %}active{% endif %}"
                   data-order-by="fecha_publicacion" data-direction="asc">
                    Fecha (Antigua)
                </a>
                <a href="{% url 'recetas_app:home' %}{% if categoria_slug %}?categoria={{ categoria_slug }}&{% else %}?{% endif %}order_by=fecha_publicacion&direction=desc"
                   class="sort-button {% if current_order_by == 'fecha_publicacion' and current_direction == 'desc' %}active{% endif %}"
                   data-order-by="fecha_publicacion" data-direction="desc">
                    Fecha (Reciente)
                </a>
                {# Ordenar por Título #}
                <a href="{% url 'recetas_app:home' %}{% if categoria_slug %}?categoria={{ categoria_slug }}&{% else %}?{% endif %}order_by=titulo&direction=asc"
                   class="sort-button {% if current_order_by == 'titulo' and current_direction == 'asc' %}active{% endif %}"
                   data-order-by="titulo" data-direction="asc">
                    Título (A-Z)
                </a>
                <a href="{% url 'recetas_app:home' %}{% if categoria_slug %}?categoria={{ categoria_slug }}&{% else %}?{% endif %}order_by=titulo&direction=desc"
                   class="sort-button {% if current_order_by == 'titulo' and current_direction == 'desc' %}active{% endif %}"
                   data-order-by="titulo" data-direction="desc">
                    Título (Z-A)
                </a>
            </div>

            {# Contenedor para la cuadrícula de recetas que se actualizará con AJAX #}
            <div id="recipes-grid-container" class="latest-recipes-grid">
                {% include 'recetas_app/partials/latest_recipes_grid.html' %}
            </div>
        </div>

        {# Este bloque solo se mostrará si no estoy autenticada #}
        {% if not user.is_authenticated %}
            <div class="section-wrapper section-bg-secondary"> 
                <div class="call-to-action-card">
                    <h2 class="call-to-action-title">¡Únete a nuestra comunidad!</h2>
                    <p class="call-to-action-text">Regístrate para guardar tus recetas favoritas y conectarte con otros amantes de la cocina.</p>
                    <a href="{% url 'usuarios:registro' %}" class="register-button-large">REGISTRATE AHORA</a>
                </div>
            </div>
        {% endif %}
    </div> {# Cierre de main-content-area #}

{% endblock %}

{% block extra_body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Manejar el envío de formularios de favoritos con AJAX 
        document.querySelectorAll('.favorite-form').forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); 
                
                const form = this;
                const button = form.querySelector('.favorite-toggle-button');
                const icon = button.querySelector('i');
                const favoriteText = form.nextElementSibling; 

                button.disabled = true;
                button.style.cursor = 'wait';

                fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.is_favorited) {
                        button.classList.add('favorited');
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        if (favoriteText) {
                            favoriteText.textContent = 'Favorited';
                        }
                    } else {
                        button.classList.remove('favorited');
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        if (favoriteText) {
                            favoriteText.textContent = 'Add to favorites';
                        }
                    }
                    button.disabled = false;
                    button.style.cursor = 'pointer';
                })
                .catch(error => {
                    console.error('Error toggling favorite:', error);
                    button.disabled = false;
                    button.style.cursor = 'pointer';
                    // Reemplazado alert() por un mensaje en la consola
                    console.error('Hubo un error al actualizar el favorito. Por favor, inténtalo de nuevo.');
                });
            });
        });

        // Manejar clics en los botones de ordenamiento con AJAX
        document.querySelectorAll('.sort-button').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevenir la recarga completa de la página

                const currentUrl = new URL(window.location.href);
                const orderBy = this.dataset.orderBy;
                const direction = this.dataset.direction;

                // Actualizar los parámetros de la URL
                currentUrl.searchParams.set('order_by', orderBy);
                currentUrl.searchParams.set('direction', direction);

                // Obtener el slug de la categoría si existe en la URL actual
                const categoriaSlug = currentUrl.searchParams.get('categoria');
                if (categoriaSlug) {
                    currentUrl.searchParams.set('categoria', categoriaSlug);
                }

                // Desactivar todos los botones de ordenamiento y activar el actual
                document.querySelectorAll('.sort-button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // Realizar la petición AJAX
                fetch(currentUrl.toString(), {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Indica que es una petición AJAX
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // Esperamos una respuesta JSON con el HTML
                })
                .then(data => {
                    // Inyectar el HTML de las recetas actualizado en el contenedor
                    const recipesGridContainer = document.getElementById('recipes-grid-container');
                    if (recipesGridContainer) {
                        recipesGridContainer.innerHTML = data.html;

                        // Re-adjuntar listeners de favoritos a las nuevas tarjetas (si es necesario)
                        // Esto es importante porque el contenido se ha reemplazado
                        document.querySelectorAll('#recipes-grid-container .favorite-form').forEach(form => {
                            form.addEventListener('submit', function(e) {
                                e.preventDefault();
                                // Lógica de AJAX para favoritos, la misma que arriba
                                const form = this;
                                const button = form.querySelector('.favorite-toggle-button');
                                const icon = button.querySelector('i');
                                const favoriteText = form.nextElementSibling; 

                                button.disabled = true;
                                button.style.cursor = 'wait';

                                fetch(form.action, {
                                    method: 'POST',
                                    body: new FormData(form),
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.is_favorited) {
                                        button.classList.add('favorited');
                                        icon.classList.remove('far');
                                        icon.classList.add('fas');
                                        if (favoriteText) {
                                            favoriteText.textContent = 'Favorited';
                                        }
                                    } else {
                                        button.classList.remove('favorited');
                                        icon.classList.remove('fas');
                                        icon.classList.add('far');
                                        if (favoriteText) {
                                            favoriteText.textContent = 'Add to favorites';
                                        }
                                    }
                                    button.disabled = false;
                                    button.style.cursor = 'pointer';
                                })
                                .catch(error => {
                                    console.error('Error toggling favorite on new content:', error);
                                    button.disabled = false;
                                    button.style.cursor = 'pointer';
                                    console.error('Hubo un error al actualizar el favorito. Por favor, inténtalo de nuevo.');
                                });
                            });
                        });

                        // Re-adjuntar listeners para las tarjetas clickeables (si es necesario)
                        document.querySelectorAll('#recipes-grid-container .clickable-card').forEach(card => {
                            card.addEventListener('click', function(event) {
                                if (event.target.closest('form') || event.target.tagName === 'A' || event.target.closest('a')) {
                                    return;
                                }
                                const url = this.dataset.url;
                                if (url) {
                                    window.location.href = url;
                                }
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al ordenar recetas:', error);
                    console.error('Hubo un error al ordenar las recetas. Por favor, inténtalo de nuevo.');
                });
            });
        });
    });
</script>
{% endblock %}
